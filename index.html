<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AShare 智能投研分析预览</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif; /* Using Inter as a modern font */
        }
        .card-header {
            cursor: pointer;
        }
        .card-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out;
        }
        .card-content.expanded {
            max-height: 2000px; /* Adjust as needed for content */
            transition: max-height 0.5s ease-in;
        }
        /* Custom scrollbar for better aesthetics if content overflows */
        .report-section-content::-webkit-scrollbar {
            width: 6px;
        }
        .report-section-content::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }
        .report-section-content::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 10px;
        }
        .report-section-content::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
</head>
<body class="bg-gray-100 text-gray-800">

    <nav class="bg-white shadow-md fixed top-0 left-0 right-0 z-50">
        <div class="container mx-auto px-6 py-3 flex justify-between items-center">
            <a href="#" class="text-2xl font-bold text-blue-600">
                <i class="fas fa-chart-line mr-2"></i>AShare 股见
            </a>
            <div></div> {/* This empty div helps maintain the layout if needed, or can be removed if AShare 股见 should be centered or left-aligned fully */}
        </div>
    </nav>

    <div class="container mx-auto px-4 sm:px-6 lg:px-8 pt-24 pb-12">
        <section id="input-section" class="bg-white p-6 sm:p-8 rounded-xl shadow-lg mb-8">
            <h2 class="text-2xl sm:text-3xl font-semibold text-center text-gray-700 mb-6">
                输入股票代码，获取深度分析报告
            </h2>
            <div class="max-w-xl mx-auto">
                <div class="flex flex-col sm:flex-row items-center gap-4">
                    <input type="text" id="stock-code" placeholder="例如：301312"
                           class="flex-grow w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none transition-shadow text-lg" />
                    <button id="analyze-button"
                            class="w-full sm:w-auto bg-blue-600 hover:bg-blue-700 text-white font-semibold px-8 py-3 rounded-lg transition-colors text-lg shadow-md hover:shadow-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2">
                        <i class="fas fa-search mr-2"></i>立即分析
                    </button>
                </div>
            </div>
        </section>

        <section id="results-section">
            <div id="loader" class="hidden loader"></div>
            <div id="error-message" class="hidden bg-red-100 border-l-4 border-red-500 text-red-700 p-4 rounded-md shadow-md" role="alert">
                <p class="font-bold">错误</p>
                <p id="error-text"></p>
            </div>
            <div id="report-container" class="space-y-6">
                <div class="bg-gray-200 p-6 rounded-lg text-center text-gray-500 initial-prompt">
                    <i class="fas fa-info-circle fa-2x mb-3"></i>
                    <p class="text-lg">请输入股票代码以开始分析。</p>
                </div>
            </div>
        </section>
    </div>

    <footer class="bg-gray-800 text-white py-8 text-center mt-12">
        <div class="container mx-auto">
            <p>&copy; 2024-2025 AShare 股见。由A股MCP智能体强力驱动。</p>
            <p class="text-sm text-gray-400 mt-2">免责声明：本报告仅供参考，不构成任何投资建议。</p>
        </div>
    </footer>

    <script>
        // --- DOM Elements ---
        const stockCodeInput = document.getElementById('stock-code');
        const analyzeButton = document.getElementById('analyze-button');
        const reportContainer = document.getElementById('report-container');
        const loader = document.getElementById('loader');
        const errorMessageDiv = document.getElementById('error-message');
        const errorTextP = document.getElementById('error-text');
        const initialPromptDiv = document.querySelector('.initial-prompt');

        // --- Event Listeners ---
        analyzeButton.addEventListener('click', handleAnalyze);

        // --- Functions ---
        async function handleAnalyze() {
            const stockCode = stockCodeInput.value.trim();
            if (!stockCode) {
                showError("请输入股票代码。");
                return;
            }

            if(initialPromptDiv) initialPromptDiv.classList.add('hidden');
            hideError();
            reportContainer.innerHTML = '';
            loader.classList.remove('hidden');
            analyzeButton.disabled = true;
            analyzeButton.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>分析中...';

            try {
                const API_BASE = "https://api.keith.us.kg";

                // 1. 发起分析任务
                const startRes = await fetch(`${API_BASE}/api/analysis/start`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ ticker: stockCode, show_reasoning: true })
                });
                const startData = await startRes.json();
                if (!startData.success) throw new Error(startData.message || '分析任务启动失败');
                const runId = startData.data.run_id;

                // 2. 轮询任务状态
                let isComplete = false;
                let pollCount = 0;
                while (!isComplete && pollCount < 60) { // 最多轮询60次，防止死循环
                    await new Promise(r => setTimeout(r, 1500));
                    const statusRes = await fetch(`${API_BASE}/api/analysis/${runId}/status`);
                    const statusData = await statusRes.json();
                    if (!statusData.success) throw new Error(statusData.message || '状态查询失败');
                    isComplete = statusData.data.is_complete;
                    pollCount++;
                }
                if (!isComplete) throw new Error("分析超时，请稍后重试。");

                // 3. 获取最终结果
                const resultRes = await fetch(`${API_BASE}/api/analysis/${runId}/result`);
                const resultJson = await resultRes.json();
                if (!resultJson.success) throw new Error(resultJson.message || '获取结果失败');
                const resultData = resultJson.data;

                // 4. 渲染
                const parsedReport = parseReportDataFromApi(resultData, stockCode);
                renderReport(parsedReport);
                loader.classList.add('hidden');
            } catch (e) {
                console.error("Error:", e);
                showError(e.message || "分析失败，请重试。");
                loader.classList.add('hidden');
            } finally {
                analyzeButton.disabled = false;
                analyzeButton.innerHTML = '<i class="fas fa-search mr-2"></i>立即分析';
            }
        }

        function showError(message) {
            errorTextP.textContent = message;
            errorMessageDiv.classList.remove('hidden');
        }

        function hideError() {
            errorMessageDiv.classList.add('hidden');
        }

        // 适配后端API返回结构
        function parseReportDataFromApi(apiData, stockCode) {
            // 假设后端返回结构为 { title, analysisDate, sections: [{title, content: [string]}] }
            // 如需适配实际结构请调整
            return {
                title: apiData.title || `股票代码 ${stockCode} 投资分析报告`,
                analysisDate: apiData.analysisDate || '',
                sections: apiData.sections || []
            };
        }

        function getSignalColor(signalText) {
            if (!signalText) return 'text-gray-700';
            const lowerSignal = signalText.toLowerCase();
            if (lowerSignal.includes('bullish') || lowerSignal.includes('多方')) return 'text-green-600 font-semibold';
            if (lowerSignal.includes('bearish') || lowerSignal.includes('空方')) return 'text-red-600 font-semibold';
            if (lowerSignal.includes('neutral') || lowerSignal.includes('中性')) return 'text-blue-600 font-semibold';
            if (lowerSignal.includes('hold') || lowerSignal.includes('持有')) return 'text-yellow-600 font-semibold';
            return 'text-gray-700';
        }

        function renderReport(report) {
            reportContainer.innerHTML = ''; // Clear previous content or loader

            const reportHeaderDiv = document.createElement('div');
            reportHeaderDiv.className = 'mb-8 text-center';
            if (report.title) {
                const titleEl = document.createElement('h1');
                titleEl.className = 'text-3xl sm:text-4xl font-bold text-gray-800 mb-2';
                titleEl.textContent = report.title;
                reportHeaderDiv.appendChild(titleEl);
            }
            if (report.analysisDate) {
                const dateEl = document.createElement('p');
                dateEl.className = 'text-md text-gray-600';
                dateEl.textContent = report.analysisDate;
                reportHeaderDiv.appendChild(dateEl);
            }
            reportContainer.appendChild(reportHeaderDiv);

            report.sections.forEach((section, index) => {
                const card = document.createElement('div');
                card.className = 'bg-white rounded-xl shadow-lg overflow-hidden transition-all duration-300 ease-in-out';

                const header = document.createElement('div');
                header.className = 'card-header p-5 sm:p-6 border-b border-gray-200 flex justify-between items-center bg-gray-50 hover:bg-gray-100 transition-colors';
                header.innerHTML = `
                    <h3 class="text-xl sm:text-2xl font-semibold text-gray-700">${section.title}</h3>
                    <i class="fas fa-chevron-down transform transition-transform duration-300"></i>
                `;

                const contentWrapper = document.createElement('div');
                contentWrapper.className = 'card-content'; // Collapsed by default

                const content = document.createElement('div');
                content.className = 'report-section-content p-5 sm:p-6 text-sm sm:text-base leading-relaxed space-y-1';
                content.style.fontFamily = "'SFMono-Regular', Consolas, 'Liberation Mono', Menlo, Courier, monospace"; // Monospace for report text

                section.content.forEach(lineText => {
                    const lineDiv = document.createElement('div');
                    const indentMatch = lineText.match(/^(\s*)/);
                    const indentation = indentMatch ? indentMatch[0].length : 0;
                    
                    let cleanedText = lineText.replace(/^[\s├└─●+-]*/, '').trim(); // Remove prefixes for cleaner display

                    // Apply color to signals
                    if (cleanedText.toLowerCase().includes('signal:') || cleanedText.toLowerCase().includes('perspective:')) {
                        const parts = cleanedText.split(':');
                        if (parts.length > 1) {
                            const key = parts[0].trim();
                            const value = parts.slice(1).join(':').trim();
                            const valueSpan = `<span class="${getSignalColor(value)}">${value}</span>`;
                            lineDiv.innerHTML = `${key}: ${valueSpan}`;
                        } else {
                           lineDiv.textContent = cleanedText;
                        }
                    } else {
                        lineDiv.textContent = cleanedText;
                    }
                    
                    // Basic indentation styling
                    if (indentation > 0) {
                        lineDiv.style.marginLeft = `${indentation * 0.5}em`; // Adjust multiplier as needed
                    }
                    if (cleanedText.startsWith("Bullish Arguments:") || cleanedText.startsWith("Bearish Arguments:") || /^[A-Z][a-zA-Z\s_]+:$/.test(cleanedText) && !cleanedText.includes('%')) {
                         lineDiv.classList.add('font-semibold', 'mt-2', 'text-gray-600');
                    }

                    // Special handling for LLM/API errors to make them more visible
                    if (cleanedText.includes("LLM分析失败") || cleanedText.includes("API error occurred")) {
                        lineDiv.classList.add('text-red-500', 'font-semibold', 'p-2', 'bg-red-50', 'rounded-md');
                    }


                    content.appendChild(lineDiv);
                });

                contentWrapper.appendChild(content);
                card.appendChild(header);
                card.appendChild(contentWrapper);
                reportContainer.appendChild(card);

                // Expand/Collapse functionality
                header.addEventListener('click', () => {
                    contentWrapper.classList.toggle('expanded');
                    const icon = header.querySelector('i');
                    icon.classList.toggle('fa-chevron-down');
                    icon.classList.toggle('fa-chevron-up');
                });

                // Auto-expand the first few cards for better initial view
                if (index < 2) { // Expand first 2 cards
                    header.click();
                }
            });
        }

        // Basic theme toggle placeholder - removed as per request
        // const themeToggleButton = document.getElementById('theme-toggle');
        // if (themeToggleButton) {
        //     themeToggleButton.addEventListener('click', () => {
        //         alert('主题切换功能待实现！\n(Theme toggle functionality to be implemented!)');
        //     });
        // }
    </script>
</body>
</html>
